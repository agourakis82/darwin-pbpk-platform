apiVersion: batch/v1
kind: Job
metadata:
  name: dynamic-gnn-training-sota
  namespace: darwin-pbpk-platform
  labels:
    app: darwin-pbpk-platform
    component: training
    version: sota
    gpu: l4
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 86400  # 24 horas
  template:
    metadata:
      labels:
        app: darwin-pbpk-platform
        component: training
        version: sota
        gpu: l4
    spec:
      # Node selector para for√ßar execu√ß√£o no node maria
      nodeSelector:
        kubernetes.io/hostname: maria
      restartPolicy: Never
      # Tolerar taints se houver
      tolerations:
      - key: "nvidia.com/gpu"
        operator: "Exists"
        effect: "NoSchedule"
      containers:
      - name: training
        # Usar imagem com CUDA support
        image: pytorch/pytorch:2.4.0-cuda12.1-cudnn9-runtime
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash"]
        args:
          - -c
          - |
            set -e
            set -o pipefail
            export DEBIAN_FRONTEND=noninteractive
            LOG_DIR="/workspace/darwin-pbpk-platform/logs"
            mkdir -p "$LOG_DIR"
            LOG_FILE="$LOG_DIR/dynamic_gnn_sota_maria.log"
            exec > >(tee -a "$LOG_FILE") 2>&1
            
            echo "================================================================================"
            echo "TREINAMENTO SOTA: Dynamic GNN para PBPK"
            echo "Node Maria (L4 24GB) - Metodologia State-of-the-Art"
            echo "================================================================================"
            echo ""
            echo "üìç Node: $(hostname)"
            if command -v nvidia-smi >/dev/null 2>&1; then
              echo "üìç GPU: $(nvidia-smi --query-gpu=name,memory.total --format=csv,noheader 2>/dev/null || echo 'Indispon√≠vel')"
            else
              echo "‚ö†Ô∏è  nvidia-smi n√£o dispon√≠vel nesta imagem"
            fi
            echo ""
            
            echo "‚úÖ Ambiente PyTorch pr√©-instalado (pytorch/pytorch)"
            python3 -m pip install --no-cache-dir --upgrade pip
            
            # Verificar CUDA
            python3 -c "import torch; print(f'‚úÖ PyTorch {torch.__version__}'); print(f'‚úÖ CUDA dispon√≠vel: {torch.cuda.is_available()}'); print(f'‚úÖ CUDA version: {torch.version.cuda if torch.cuda.is_available() else \"N/A\"}')"
            
            # Instalar outras depend√™ncias
            echo "üì¶ Instalando depend√™ncias Python..."
            python3 -m pip install --no-cache-dir numpy scipy matplotlib tqdm pydantic networkx
            python3 -m pip install --no-cache-dir pyg_lib torch_scatter torch_sparse torch_cluster torch_spline_conv -f https://data.pyg.org/whl/torch-2.4.0+cu121.html
            python3 -m pip install --no-cache-dir torch-geometric
            
            # Preparar c√≥digo
            echo "üì• Preparando c√≥digo..."
            if [ -d "/workspace/darwin-pbpk-platform" ]; then
                cd /workspace/darwin-pbpk-platform
                echo "‚úÖ Usando c√≥digo do workspace compartilhado"
            else
                echo "‚ö†Ô∏è  Workspace n√£o encontrado, clonando..."
                git clone --depth 1 https://github.com/agourakis82/darwin-pbpk-platform.git /app
                cd /app
            fi
            
            # Verificar dataset
            DATA_PATH="data/dynamic_gnn_training_full/training_data.npz"
            if [ ! -f "$DATA_PATH" ]; then
                echo "üìä Gerando dataset..."
                python3 scripts/generate_dynamic_gnn_training_data.py \
                    --num-samples 1000 \
                    --output-dir data/dynamic_gnn_training_full \
                    --seed 42 || echo "‚ö†Ô∏è  Erro ao gerar dataset, continuando..."
            else
                echo "‚úÖ Dataset encontrado: $DATA_PATH"
            fi
            
            # Executar treinamento SOTA
            echo ""
            echo "üöÄ Iniciando treinamento SOTA..."
            echo "   - Mixed Precision Training (AMP)"
            echo "   - Gradient Clipping"
            echo "   - Cosine Annealing LR Schedule"
            echo "   - Early Stopping"
            echo ""
            
            python3 scripts/train_dynamic_gnn_sota.py \
                --data "$DATA_PATH" \
                --output models/dynamic_gnn_sota_maria \
                --epochs 50 \
                --batch-size 32 \
                --lr 1e-3 \
                --device cuda \
                --gradient-clip 1.0 \
                --warmup-epochs 5 \
                --patience 10 \
                --num-workers 4
            
            echo ""
            echo "‚úÖ Treinamento SOTA conclu√≠do!"
            echo "   Modelos salvos em: models/dynamic_gnn_sota_maria/"
            echo ""
            echo "üìä Verificando arquivos gerados..."
            ls -lh models/dynamic_gnn_sota_maria/ 2>/dev/null || echo "‚ö†Ô∏è  Diret√≥rio n√£o encontrado"
        
        env:
        - name: CUDA_VISIBLE_DEVICES
          value: "0"
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: PYTORCH_CUDA_ALLOC_CONF
          value: "max_split_size_mb:512"
        
        resources:
          requests:
            memory: "8Gi"
            cpu: "4000m"
          limits:
            memory: "24Gi"
            cpu: "8000m"
        
        volumeMounts:
        - name: workspace
          mountPath: /workspace
          readOnly: false
      
      volumes:
      - name: workspace
        hostPath:
          path: /home/agourakis82/workspace
          type: Directory

