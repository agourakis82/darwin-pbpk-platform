apiVersion: batch/v1
kind: Job
metadata:
  name: clearance-sota-training
  namespace: darwin-pbpk-platform
  labels:
    app: darwin-pbpk-platform
    component: training
    version: sota-clearance
    gpu: l4
    scientific: "true"
spec:
  backoffLimit: 1  # Permitir 1 retry em caso de falha tempor√°ria
  ttlSecondsAfterFinished: 172800  # 48 horas (treinamento cient√≠fico pode demorar)
  template:
    metadata:
      labels:
        app: darwin-pbpk-platform
        component: training
        version: sota-clearance
        gpu: l4
        scientific: "true"
    spec:
      # Node selector para for√ßar execu√ß√£o no node maria (L4 24GB)
      nodeSelector:
        kubernetes.io/hostname: maria
      restartPolicy: Never
      # Tolerar taints se houver
      tolerations:
      - key: "nvidia.com/gpu"
        operator: "Exists"
        effect: "NoSchedule"
      containers:
      - name: training
        # Usar imagem PyTorch com CUDA 12.1
        image: pytorch/pytorch:2.4.0-cuda12.1-cudnn9-runtime
        imagePullPolicy: IfNotPresent
        command: ["/bin/bash"]
        args:
          - -c
          - |
            set -o pipefail
            export DEBIAN_FRONTEND=noninteractive

            # Configurar logging ANTES de qualquer coisa
            LOG_DIR="/workspace/darwin-pbpk-platform/logs"
            mkdir -p "$LOG_DIR" || true
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            LOG_FILE="$LOG_DIR/clearance_sota_training_${TIMESTAMP}.log"

            # Redirecionar output para log
            exec > >(tee -a "$LOG_FILE") 2>&1 || exec > "$LOG_FILE" 2>&1

            # Trap para capturar erros (ap√≥s logging estar configurado)
            trap 'echo "‚ùå ERRO na linha $LINENO: $BASH_COMMAND" >> "$LOG_FILE" 2>&1; exit 1' ERR

            # Fun√ß√£o para verificar comandos cr√≠ticos
            check_command() {
                if ! command -v "$1" >/dev/null 2>&1; then
                    echo "‚ùå ERRO: Comando '$1' n√£o encontrado!"
                    exit 1
                fi
            }

            echo "================================================================================"
            echo "üî¨ SCIENTIFIC TRAINING: Single-Task Clearance - Full Multimodal Encoder"
            echo "Node Maria (L4 24GB) - Metodologia State-of-the-Art Q1"
            echo "================================================================================"
            echo ""
            echo "üìç Node: $(hostname)"
            echo "‚è∞ In√≠cio: $(date)"
            if command -v nvidia-smi >/dev/null 2>&1; then
              echo "üìç GPU: $(nvidia-smi --query-gpu=name,memory.total --format=csv,noheader 2>/dev/null || echo 'Indispon√≠vel')"
            else
              echo "‚ö†Ô∏è  nvidia-smi n√£o dispon√≠vel nesta imagem"
            fi
            echo ""

            # Verificar comandos cr√≠ticos
            echo "üîç Verificando comandos cr√≠ticos..."
            check_command python3
            check_command pip
            echo "‚úÖ Comandos b√°sicos OK"

            # Verificar ambiente PyTorch
            echo ""
            echo "‚úÖ Ambiente PyTorch pr√©-instalado (pytorch/pytorch)"
            python3 -m pip install --no-cache-dir --upgrade pip setuptools wheel || {
                echo "‚ùå ERRO: Falha ao atualizar pip"
                exit 1
            }

            # Verificar CUDA
            echo ""
            echo "üîç Verificando ambiente CUDA..."
            python3 -c "import torch; import sys; print(f'PyTorch {torch.__version__}'); print(f'CUDA dispon√≠vel: {torch.cuda.is_available()}'); assert torch.cuda.is_available(), 'CUDA n√£o dispon√≠vel'; print(f'CUDA version: {torch.version.cuda}'); print(f'GPU count: {torch.cuda.device_count()}'); print(f'GPU name: {torch.cuda.get_device_name(0)}')" || {
                echo "‚ùå ERRO: Falha ao verificar CUDA ou CUDA n√£o dispon√≠vel"
                exit 1
            }

            # Instalar depend√™ncias cient√≠ficas
            echo ""
            echo "üì¶ Instalando depend√™ncias cient√≠ficas..."
            python3 -m pip install --no-cache-dir \
                numpy>=1.24.0 \
                scipy>=1.10.0 \
                pandas>=2.0.0 \
                scikit-learn>=1.3.0 \
                matplotlib>=3.7.0 \
                tqdm>=4.65.0 \
                pydantic>=2.0.0 \
                networkx>=3.1 \
                rdkit-pypi \
                transformers>=4.30.0 \
                PyTDC || {
                echo "‚ùå ERRO: Falha ao instalar depend√™ncias cient√≠ficas cr√≠ticas"
                exit 1
            }

            # Wandb √© opcional
            python3 -m pip install --no-cache-dir wandb || echo "‚ö†Ô∏è  Wandb opcional, continuando..."

            # Instalar PyTorch Geometric e depend√™ncias
            echo ""
            echo "üì¶ Instalando PyTorch Geometric..."
            python3 -m pip install --no-cache-dir \
                pyg_lib torch_scatter torch_sparse torch_cluster torch_spline_conv \
                -f https://data.pyg.org/whl/torch-2.4.0+cu121.html || {
                echo "‚ö†Ô∏è  Erro ao instalar PyG extensions, tentando continuar..."
            }
            python3 -m pip install --no-cache-dir torch-geometric || {
                echo "‚ö†Ô∏è  Erro ao instalar torch-geometric, tentando continuar..."
            }

            # Verificar se imports cr√≠ticos funcionam
            echo ""
            echo "üîç Verificando imports cr√≠ticos..."
            python3 -c "import numpy; import pandas; import torch; import sklearn; from tdc.single_pred import ADME; print('‚úÖ Imports b√°sicos OK')" || {
                echo "‚ùå ERRO: Falha ao importar depend√™ncias cr√≠ticas"
                exit 1
            }

            # Preparar c√≥digo
            echo ""
            echo "üì• Preparando c√≥digo..."
            if [ -d "/workspace/darwin-pbpk-platform" ]; then
                cd /workspace/darwin-pbpk-platform
                echo "‚úÖ Usando c√≥digo do workspace compartilhado"
                echo "   Path: $(pwd)"
                git log -1 --oneline 2>/dev/null || echo "   (n√£o √© um repo git ou sem hist√≥rico)"
            else
                echo "‚ö†Ô∏è  Workspace n√£o encontrado, clonando..."
                git clone --depth 1 https://github.com/agourakis82/darwin-pbpk-platform.git /app
                cd /app
            fi

            # Verificar estrutura do projeto
            echo ""
            echo "üîç Verificando estrutura do projeto..."
            if [ ! -f "apps/training/03_single_task_clearance_multimodal.py" ]; then
                echo "‚ùå ERRO: Script de treinamento n√£o encontrado!"
                exit 1
            fi
            echo "‚úÖ Script de treinamento encontrado"

            if [ ! -d "apps/pbpk_core/ml/multimodal" ]; then
                echo "‚ùå ERRO: Diret√≥rio multimodal encoder n√£o encontrado!"
                exit 1
            fi
            echo "‚úÖ Diret√≥rio multimodal encoder encontrado"

            # Verificar se o script Python pode ser importado (simplificado)
            echo ""
            echo "üîç Verificando imports do script de treinamento..."
            python3 -c "import sys; from pathlib import Path; sys.path.insert(0, str(Path('.').resolve())); from apps.pbpk_core.ml.multimodal import MultimodalMolecularEncoder; print('‚úÖ MultimodalMolecularEncoder importado com sucesso')" || {
                echo "‚ùå ERRO: Falha ao importar m√≥dulos do projeto"
                exit 1
            }

            # Criar diret√≥rios de sa√≠da
            OUTPUT_DIR="models/clearance_sota_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$OUTPUT_DIR"
            echo "üìÅ Diret√≥rio de sa√≠da: $OUTPUT_DIR"

            # Executar treinamento cient√≠fico
            echo ""
            echo "üöÄ Iniciando treinamento cient√≠fico SOTA..."
            echo "   - Single-task Clearance model"
            echo "   - Full multimodal encoder (976d)"
            echo "   - 5-fold cross-validation"
            echo "   - Target: R¬≤ > 0.50"
            echo ""

            # Executar treinamento com valida√ß√£o pr√©via (simplificada)
            echo ""
            echo "üîç Validando script de treinamento antes de executar..."
            python3 -c "import sys; from pathlib import Path; sys.path.insert(0, str(Path('.').resolve())); code = open('apps/training/03_single_task_clearance_multimodal.py').read(); compile(code, 'apps/training/03_single_task_clearance_multimodal.py', 'exec'); print('‚úÖ Script Python v√°lido')" || {
                echo "‚ùå ERRO: Script de treinamento tem erros de sintaxe"
                exit 1
            }

            echo ""
            echo "üöÄ Executando treinamento cient√≠fico..."
            python3 apps/training/03_single_task_clearance_multimodal.py \
                --output-dir "$OUTPUT_DIR" \
                --device cuda \
                --batch-size 32 \
                --epochs 100 \
                --lr 1e-4 \
                --patience 15 \
                --num-folds 5 \
                2>&1 | tee "$OUTPUT_DIR/training.log"

            TRAIN_EXIT_CODE=${PIPESTATUS[0]}

            # Verificar se o log foi criado
            if [ ! -f "$OUTPUT_DIR/training.log" ]; then
                echo "‚ö†Ô∏è  Arquivo de log n√£o foi criado"
            else
                echo "‚úÖ Log de treinamento salvo: $OUTPUT_DIR/training.log"
                echo "üìä √öltimas 20 linhas do log:"
                tail -20 "$OUTPUT_DIR/training.log" || true
            fi

            echo ""
            echo "================================================================================"
            if [ $TRAIN_EXIT_CODE -eq 0 ]; then
                echo "‚úÖ Treinamento cient√≠fico conclu√≠do com sucesso!"
            else
                echo "‚ùå Treinamento cient√≠fico falhou com c√≥digo de sa√≠da: $TRAIN_EXIT_CODE"
            fi
            echo "================================================================================"
            echo ""
            echo "üìä Verificando resultados..."
            echo "   Diret√≥rio: $OUTPUT_DIR"
            ls -lh "$OUTPUT_DIR" 2>/dev/null || echo "‚ö†Ô∏è  Diret√≥rio n√£o encontrado"
            echo ""
            echo "üìù Logs salvos em: $LOG_FILE"
            echo "‚è∞ Fim: $(date)"

            # Exit com c√≥digo de erro se treinamento falhou
            exit $TRAIN_EXIT_CODE

        env:
        - name: CUDA_VISIBLE_DEVICES
          value: "0"
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: PYTORCH_CUDA_ALLOC_CONF
          value: "max_split_size_mb:512"
        - name: TRANSFORMERS_CACHE
          value: "/workspace/.cache/huggingface"
        - name: HF_HOME
          value: "/workspace/.cache/huggingface"

        resources:
          requests:
            memory: "16Gi"
            cpu: "6000m"
          limits:
            memory: "24Gi"
            cpu: "8000m"

        volumeMounts:
        - name: workspace
          mountPath: /workspace
          readOnly: false
        - name: cache
          mountPath: /workspace/.cache
          readOnly: false

      volumes:
      - name: workspace
        hostPath:
          path: /home/agourakis82/workspace
          type: Directory
      - name: cache
        emptyDir: {}

